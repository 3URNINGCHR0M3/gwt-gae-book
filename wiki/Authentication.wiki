#summary Authentication with OpenID

<wiki:toc max_depth="2" />

= Signing in =
*Pre-requisites*

 * [http://en.wikipedia.org/wiki/OpenID OpenID introduction]
 * [http://code.google.com/appengine/docs/java/users/overview.html AppEngine Users Java API overview]
 * [http://code.google.com/intl/nl-NL/appengine/articles/openid.html Using federated authentication via OpenID]

Here are the steps to add authentication support
 # define [http://code.google.com/p/gwt-gae-book/source/browse/trunk/CultureShows/src/org/gwtgaebook/CultureShows/shared/model/UserInfo.java UserInfo] model, used to send user information from server to client 
 # [http://code.google.com/p/gwt-gae-book/source/browse/trunk/CultureShows/src/org/gwtgaebook/CultureShows/client/MainModule.java bind UserInfo] as [http://google-guice.googlecode.com/svn/trunk/javadoc/com/google/inject/Binder.html Guice Singleton]. This will make an !UserInfo instance persist in all client, as if it were a static class. TODO true?
 # define !GetUser [http://code.google.com/p/gwt-gae-book/source/browse/trunk/CultureShows/src/org/gwtgaebook/CultureShows/shared/dispatch/GetUser.java action/result generator] and [http://code.google.com/p/gwt-gae-book/source/browse/trunk/CultureShows/src/org/gwtgaebook/CultureShows/server/dispatch/GetUserHandler.java handler], [http://code.google.com/p/gwt-gae-book/source/browse/trunk/CultureShows/src/org/gwtgaebook/CultureShows/server/MainHandlerModule.java bind them]
{{{
	public GetUserResult execute(GetUserAction action, ExecutionContext context)
			throws ActionException {

		UserInfo userInfo = new UserInfo();

		UserService userService = UserServiceFactory.getUserService();
		User user = userService.getCurrentUser();

		if (user != null) {
			userInfo.isSignedIn = true;
			userInfo.signOutURL = userService.createLogoutURL(action
					.getRequestURI());
			userInfo.email = user.getEmail();
			userInfo.userId = user.getUserId();
		} else {
			userInfo.isSignedIn = false;
			userInfo.signInURLs.put("Google", userService.createLoginURL(action
					.getRequestURI(), null, "google.com/accounts/o8/id", null));
			userInfo.signInURLs.put("Yahoo", userService.createLoginURL(action
					.getRequestURI(), null, "yahoo.com", null));
		}

		return new GetUserResult("", userInfo);
}
}}}
 # in `LandingPage` presenter, get user info from server
{{{
		dispatcher.execute(new GetUserAction(Window.Location.getHref()),
				new DispatchCallback<GetUserResult>() {
					@Override
					public void onSuccess(GetUserResult result) {
						if (!result.getErrorText().isEmpty()) {
							// TODO have a general handler for this
							Window.alert(result.getErrorText());
							return;
						}
						setUserInfo(result.getUserInfo());
					}
				});
...

	public void setUserInfo(UserInfo userInfo) {
		this.userInfo = userInfo;
		getView().setSignInOut(userInfo);
	}
}}}
 # in `LandingPage` View have a basic UI for signing in/out
{{{
	@UiField
	HTML signInOut;

	public void setSignInOut(UserInfo userInfo) {
		String html;
		if (userInfo.isSignedIn) {
			html = userInfo.email + " | " + "<a href='" + userInfo.signOutURL
					+ "'>Sign Out</a>";
		} else {
			html = "<a href='" + userInfo.signInURLs.get("Google")
					+ "'>Sign In with Google</a>" + " | " + "<a href='"
					+ userInfo.signInURLs.get("Yahoo")
					+ "'>Sign In with Yahoo</a>";

		}
		signInOut.setHTML(html);

	}
}}}

It's really that easy. The result?

_Signed out_ <br/>
<img src="http://gwt-gae-book.googlecode.com/svn/wiki/assets/signedOut.png" border="1"  />

-----

_Signing in with Google_ <br/>
<img src="http://gwt-gae-book.googlecode.com/svn/wiki/assets/signingInG.png" border="1"  />

-----

_Signed in with Google_ <br/>
<img src="http://gwt-gae-book.googlecode.com/svn/wiki/assets/signedInG.png" border="1"  />

-----

_Signing in with Yahoo_ <br/>
<img src="http://gwt-gae-book.googlecode.com/svn/wiki/assets/signingInY.png" border="1"  />

-----

_Signed in with Yahoo_ <br/>
<img src="http://gwt-gae-book.googlecode.com/svn/wiki/assets/signedInY.png" border="1"  />


= Updating UI to accommodate authentication =

TODO

App Engine supports more !OpenID providers. To keep the UI usable, we'll limit the options to the most popular two.

= Migrating stored anonymous data to signed in users =





<img src="http://gwt-gae-book.googlecode.com/svn/wiki/assets/envelope.png" border="0"  /><a href="http://code.google.com/p/gwt-gae-book/issues/entry">Send feedback</a>